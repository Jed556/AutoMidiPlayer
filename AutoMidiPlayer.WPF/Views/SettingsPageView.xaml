<UserControl
    x:Class="AutoMidiPlayer.WPF.Views.SettingsPageView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    mc:Ignorable="d"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:s="https://github.com/canton7/Stylet"
    xmlns:core="clr-namespace:AutoMidiPlayer.WPF.Core"
    xmlns:controls="clr-namespace:AutoMidiPlayer.WPF.Controls"
    xmlns:viewModels="clr-namespace:AutoMidiPlayer.WPF.ViewModels"
    xmlns:transitions="clr-namespace:AutoMidiPlayer.WPF.Animation.Transitions"
    xmlns:properties="clr-namespace:AutoMidiPlayer.Data.Properties;assembly=AutoMidiPlayer.Data"
    xmlns:games="clr-namespace:AutoMidiPlayer.WPF.Core.Games"
    xmlns:helpers="clr-namespace:AutoMidiPlayer.WPF.Helpers"
    d:DataContext="{d:DesignInstance Type=viewModels:SettingsPageViewModel}">
    <UserControl.Resources>
        <properties:Settings x:Key="Settings"/>
        <helpers:BindingProxy x:Key="SettingsVmProxy"
                              Data="{Binding}"/>
    </UserControl.Resources>

    <ScrollViewer>
        <controls:SimpleStackPanel>
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Left Column -->
                <controls:SimpleStackPanel Grid.Column="0"
                                           Margin="0,0,10,0">

                    <!-- Player Section -->
                    <TextBlock Text="Player"
                               FontSize="20"
                               FontWeight="SemiBold"
                               Margin="0,0,0,8"/>
                    <ui:ToggleSwitch
                        Content="Auto Enable Listen Mode"
                        IsChecked="{Binding AutoEnableListenMode}"
                        Margin="0,8,0,0"
                        ToolTip="Play will automatically switch to Listen Mode (Speakers) if the selected game isn't active."/>

                    <ui:ToggleSwitch
                        Content="Use Direct Input (recommended)"
                        IsChecked="{Binding UseDirectInput}"
                        ToolTip="Uses Win32 SendInput for better game compatibility. Disable only if experiencing issues."/>

                    <TextBlock Text="Direct Input uses low-level Windows API for better compatibility with games. Disable this if notes are not being detected correctly."
                               TextWrapping="Wrap"
                               Opacity="0.6"
                               FontSize="12"
                               Margin="0,8,0,0"/>

                    <ui:ToggleSwitch
                        Content="Use Window Message"
                        IsChecked="{Binding UseWindowMessage}"
                        ToolTip="Sends WM_KEYDOWN directly to the game window instead of global SendInput. Use this for games like Sky: CotL that detect and block injected input."/>



                    <!-- Keybinds Section -->
                    <TextBlock Text="Keybinds"
                               FontSize="20"
                               FontWeight="SemiBold"
                               Margin="0,16,0,8"/>

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <ui:ToggleSwitch Grid.Column="0"
                                         Content="Enable global hotkeys"
                                         IsChecked="{Binding HotkeysEnabled}"
                                         ToolTip="When enabled, hotkeys work even when the app is not focused"/>
                        <Button Grid.Column="2"
                                Command="{s:Action ResetHotkeys}"
                                Style="{DynamicResource GhostIconButton}"
                                ToolTip="Reset all hotkeys to defaults"
                                Visibility="{Binding HotkeysEnabled, Converter={x:Static s:BoolToVisibilityConverter.Instance}}">
                            <ui:SymbolIcon Symbol="ArrowClockwise24"
                                           FontSize="18"/>
                        </Button>
                    </Grid>

                    <TextBlock Text="Global hotkeys work even when the app is not in focus. Requires at least one modifier key (Ctrl, Alt, Shift)."
                               TextWrapping="Wrap"
                               Opacity="0.6"
                               FontSize="12"
                               Margin="0,4,0,8"/>

                    <controls:SimpleStackPanel Spacing="8"
                                               Grid.IsSharedSizeScope="True"
                                               Visibility="{Binding HotkeysEnabled, Converter={x:Static s:BoolToVisibilityConverter.Instance}}">
                        <controls:HotkeyEditControl
                            HotkeyBinding="{Binding PlayPauseHotkey}"
                            HotkeyChanged="OnHotkeyChanged"
                            HotkeyCleared="OnHotkeyCleared"
                            EditStarted="OnHotkeyEditStarted"
                            EditEnded="OnHotkeyEditEnded"/>
                        <controls:HotkeyEditControl
                            HotkeyBinding="{Binding NextHotkey}"
                            HotkeyChanged="OnHotkeyChanged"
                            HotkeyCleared="OnHotkeyCleared"
                            EditStarted="OnHotkeyEditStarted"
                            EditEnded="OnHotkeyEditEnded"/>
                        <controls:HotkeyEditControl
                            HotkeyBinding="{Binding PreviousHotkey}"
                            HotkeyChanged="OnHotkeyChanged"
                            HotkeyCleared="OnHotkeyCleared"
                            EditStarted="OnHotkeyEditStarted"
                            EditEnded="OnHotkeyEditEnded"/>
                        <controls:HotkeyEditControl
                            HotkeyBinding="{Binding SpeedUpHotkey}"
                            HotkeyChanged="OnHotkeyChanged"
                            HotkeyCleared="OnHotkeyCleared"
                            EditStarted="OnHotkeyEditStarted"
                            EditEnded="OnHotkeyEditEnded"/>
                        <controls:HotkeyEditControl
                            HotkeyBinding="{Binding SpeedDownHotkey}"
                            HotkeyChanged="OnHotkeyChanged"
                            HotkeyCleared="OnHotkeyCleared"
                            EditStarted="OnHotkeyEditStarted"
                            EditEnded="OnHotkeyEditEnded"/>
                        <controls:HotkeyEditControl
                            HotkeyBinding="{Binding PanicHotkey}"
                            HotkeyChanged="OnHotkeyChanged"
                            HotkeyCleared="OnHotkeyCleared"
                            EditStarted="OnHotkeyEditStarted"
                            EditEnded="OnHotkeyEditEnded"/>
                    </controls:SimpleStackPanel>

                    <!-- Locations Section -->
                    <TextBlock Text="Locations"
                               FontSize="20"
                               FontWeight="SemiBold"
                               Margin="0,16,0,8"/>

                    <ItemsControl ItemsSource="{Binding GameLocations}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="{x:Type games:GameInfo}">
                                <GroupBox Margin="0,0,0,4">
                                    <GroupBox.Header>
                                        <TextBlock>
                                            <Run Text="{Binding DisplayName, Mode=OneWay}"/><Run Text=" Location"/>
                                        </TextBlock>
                                    </GroupBox.Header>
                                    <controls:SimpleStackPanel Orientation="Horizontal">
                                        <Button s:View.ActionTarget="{Binding Data, Source={StaticResource SettingsVmProxy}}"
                                                CommandParameter="{Binding}"
                                                Command="{s:Action BrowseGameLocation}"
                                                Style="{DynamicResource GhostIconButton}">
                                            <ui:SymbolIcon Symbol="AppsAddIn16"
                                                           FontSize="18"/>
                                        </Button>
                                        <TextBlock Text="{Binding Location}"
                                                   VerticalAlignment="Center"
                                                   TextTrimming="CharacterEllipsis"/>
                                    </controls:SimpleStackPanel>
                                </GroupBox>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <GroupBox Header="MIDI Folder">
                        <controls:SimpleStackPanel Orientation="Horizontal">
                            <Button Command="{s:Action BrowseMidiFolder}"
                                    Style="{DynamicResource GhostIconButton}"
                                    ToolTip="Browse for MIDI folder"
                                    Visibility="{Binding HasMidiFolder, Converter={x:Static s:BoolToVisibilityConverter.InverseInstance}}">
                                <ui:SymbolIcon Symbol="FolderAdd16"
                                               FontSize="18"/>
                            </Button>
                            <Button Command="{s:Action OpenMidiFolder}"
                                    Style="{DynamicResource GhostIconButton}"
                                    ToolTip="Open MIDI folder in Explorer"
                                    Visibility="{Binding HasMidiFolder, Converter={x:Static s:BoolToVisibilityConverter.Instance}}">
                                <ui:SymbolIcon Symbol="FolderOpen16"
                                               FontSize="18"/>
                            </Button>
                            <TextBlock Text="{Binding MidiFolder, TargetNullValue='No folder selected'}"
                                       VerticalAlignment="Center"
                                       TextTrimming="CharacterEllipsis"
                                       MaxWidth="200"/>
                            <Button Command="{s:Action ScanMidiFolder}"
                                    Style="{DynamicResource GhostIconButton}"
                                    ToolTip="Refresh/Scan folder for new MIDI files"
                                    Visibility="{Binding HasMidiFolder, Converter={x:Static s:BoolToVisibilityConverter.Instance}}">
                                <ui:SymbolIcon Symbol="ArrowClockwise24"
                                               FontSize="18"/>
                            </Button>
                            <Button Command="{s:Action ClearMidiFolder}"
                                    Style="{DynamicResource GhostIconButton}"
                                    ToolTip="Clear MIDI folder"
                                    Visibility="{Binding HasMidiFolder, Converter={x:Static s:BoolToVisibilityConverter.Instance}}">
                                <ui:SymbolIcon Symbol="Delete16"
                                               FontSize="18"/>
                            </Button>
                        </controls:SimpleStackPanel>
                    </GroupBox>

                    <GroupBox Header="Data Location">
                        <controls:SimpleStackPanel Orientation="Horizontal">
                            <Button Command="{s:Action OpenDataFolder}"
                                    Style="{DynamicResource GhostIconButton}"
                                    ToolTip="Open data folder in Explorer">
                                <ui:SymbolIcon Symbol="FolderOpen16"
                                               FontSize="18"/>
                            </Button>
                            <TextBlock Text="{x:Static viewModels:SettingsPageViewModel.DataLocation}"
                                       VerticalAlignment="Center"
                                       TextTrimming="CharacterEllipsis"
                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                       ToolTip="{x:Static viewModels:SettingsPageViewModel.DataLocation}"/>
                        </controls:SimpleStackPanel>
                    </GroupBox>

                </controls:SimpleStackPanel>

                <!-- Right Column -->
                <controls:SimpleStackPanel Grid.Column="1"
                                           Margin="10,0,0,0">

                    <!-- Version Section -->
                    <controls:SimpleStackPanel Orientation="Horizontal"
                                               Spacing="8"
                                               Margin="0,0,0,8">
                        <TextBlock Text="Version"
                                   FontSize="20"
                                   FontWeight="SemiBold"
                                   VerticalAlignment="Center"/>
                        <Border Visibility="{Binding NeedsUpdate, Converter={x:Static s:BoolToVisibilityConverter.Instance}}"
                                Background="{DynamicResource SystemAccentColorPrimaryBrush}"
                                CornerRadius="10"
                                Margin="0,4,0,0"
                                Padding="8,2"
                                VerticalAlignment="Center">
                            <TextBlock Text="New Update"
                                       FontSize="11"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource ApplicationBackgroundBrush}"/>
                        </Border>
                    </controls:SimpleStackPanel>

                    <controls:SimpleStackPanel Orientation="Horizontal"
                                               Spacing="8">
                        <TextBlock VerticalAlignment="Center">
                        v<Run Text="{Binding ProgramVersion, Mode=OneTime}"/>
                        </TextBlock>
                        <ui:SymbolIcon Symbol="TriangleRight20"
                                       FontSize="8"
                                       Filled="True"
                                       VerticalAlignment="Center"
                                       Visibility="{Binding NeedsUpdate, Converter={x:Static s:BoolToVisibilityConverter.Instance}}"/>
                        <TextBlock VerticalAlignment="Center"
                                   Visibility="{Binding NeedsUpdate, Converter={x:Static s:BoolToVisibilityConverter.Instance}}">
                            <Run Text="{Binding LatestVersion.TagName}"/>
                        </TextBlock>
                        <ui:HyperlinkButton NavigateUri="{Binding LatestVersion.Url}"
                                            Style="{DynamicResource GhostIconButton}"
                                            Padding="2"
                                            ToolTip="Open update page"
                                            Visibility="{Binding NeedsUpdate, Converter={x:Static s:BoolToVisibilityConverter.Instance}}">
                            <ui:SymbolIcon Symbol="ArrowCircleUp12"
                                           FontSize="16"
                                           Filled="True"/>
                        </ui:HyperlinkButton>
                        <Button Command="{s:Action CheckForUpdate}"
                                Style="{DynamicResource GhostIconButton}"
                                Padding="2"
                                ToolTip="Check for updates"
                                Visibility="{Binding IsCheckingUpdate, Converter={x:Static s:BoolToVisibilityConverter.InverseInstance}}">
                            <ui:SymbolIcon Symbol="ArrowClockwise24"
                                           FontSize="16"/>
                        </Button>
                        <ui:ProgressRing
                            IsIndeterminate="True"
                            Width="16"
                            Height="16"
                            IsEnabled="{Binding IsCheckingUpdate}"
                            Visibility="{Binding IsCheckingUpdate, Converter={x:Static s:BoolToVisibilityConverter.Instance}}"/>
                    </controls:SimpleStackPanel>

                    <ui:ToggleSwitch Content="Auto-check updates"
                                     IsChecked="{Binding AutoCheckUpdates}"/>
                    <ui:ToggleSwitch Content="Include beta updates"
                                     IsChecked="{Binding IncludeBetaUpdates}"/>

                    <!-- Style Section -->
                    <TextBlock Text="Style"
                               FontSize="20"
                               FontWeight="SemiBold"
                               Margin="0,16,0,8"/>

                    <GroupBox Header="Theme Mode">
                        <ComboBox
                            SelectedItem="{Binding SelectedTheme}"
                            ItemsSource="{x:Static viewModels:SettingsPageViewModel.ThemeOptions}"
                            DisplayMemberPath="Name"
                            MinWidth="150"/>
                    </GroupBox>

                    <GroupBox Header="Accent Color">
                        <ComboBox
                            SelectedItem="{Binding SelectedAccentColor}"
                            ItemsSource="{x:Static viewModels:SettingsPageViewModel.AccentColors}"
                            MinWidth="150">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal">
                                        <Border Width="16"
                                                Height="16"
                                                CornerRadius="8"
                                                Background="{Binding ColorBrush}"
                                                Margin="0,0,8,0"/>
                                        <TextBlock Text="{Binding Name}"
                                                   VerticalAlignment="Center"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                    </GroupBox>

                    <GroupBox Header="Transition Style">
                        <ComboBox
                            SelectedItem="{Binding Transition}"
                            SelectedIndex="{Binding Default.SelectedTransition, Source={StaticResource Settings}}"
                            ItemsSource="{x:Static transitions:TransitionCollection.Transitions}"
                            MinWidth="150"/>
                    </GroupBox>

                </controls:SimpleStackPanel>
            </Grid>

            <!-- License Section (full width) -->
            <TextBlock Text="License"
                       FontSize="20"
                       FontWeight="SemiBold"
                       Margin="0,16,0,8"/>

            <controls:SimpleStackPanel Spacing="4">
                <TextBlock TextWrapping="Wrap"
                           FontSize="12">
                Originally created by © 2022 sabihoshi. Modified by © 2026 Jed556 for multi-game support and modernization.
                Licensed under the
                <Hyperlink NavigateUri="{Binding Default.LicenseUri, Source={StaticResource Settings}}"
                           Style="{DynamicResource AppHyperlinkStyle}">MIT License</Hyperlink>.
                </TextBlock>
                <TextBlock TextWrapping="Wrap"
                           FontSize="12">
                This project uses third-party libraries that may be distributed under
                <Hyperlink NavigateUri="{Binding Default.ThirdPartyLicenseUri, Source={StaticResource Settings}}"
                           Style="{DynamicResource AppHyperlinkStyle}">different licenses</Hyperlink>.
                </TextBlock>
                <TextBlock TextWrapping="Wrap"
                           FontSize="11"
                           Opacity="0.7">
                           
                All rights reserved by © miHoYo Co., Ltd., © XD Inc., © thatgamecompany, Inc., and © Roblox Corporation.
                Not affiliated with miHoYo, XD, thatgamecompany, or Roblox.
                </TextBlock>
            </controls:SimpleStackPanel>
        </controls:SimpleStackPanel>
    </ScrollViewer>
</UserControl>
