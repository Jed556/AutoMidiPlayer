<UserControl x:Class="AutoMidiPlayer.WPF.Controls.HotkeyEditControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:s="https://github.com/canton7/Stylet"
             xmlns:controls="clr-namespace:AutoMidiPlayer.WPF.Controls"
             x:Name="HotkeyControl">

    <UserControl.Resources>
        <DataTemplate x:Key="HotkeyChipTemplate">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text=" + "
                           VerticalAlignment="Center"
                           Opacity="0.5"
                           Margin="0"
                           Visibility="{Binding IsFirst, Converter={x:Static s:BoolToVisibilityConverter.InverseInstance}}"/>
                <Grid>
                    <!-- Glow overlay behind the chip, same size -->
                    <Border x:Name="GlowBorder"
                            BorderThickness="1"
                            CornerRadius="4"
                            BorderBrush="{DynamicResource SystemAccentColorPrimaryBrush}"
                            Opacity="0"
                            IsHitTestVisible="False">
                        <Border.Effect>
                            <DropShadowEffect
                                Color="{DynamicResource SystemAccentColor}"
                                BlurRadius="20"
                                ShadowDepth="0"
                                Opacity="1"/>
                        </Border.Effect>
                        <Border.Style>
                            <Style TargetType="Border">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsGlowActive, ElementName=HotkeyControl}"
                                                 Value="True">
                                        <DataTrigger.EnterActions>
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation
                                                        Storyboard.TargetProperty="Opacity"
                                                        To="1"
                                                        Duration="0:0:0.05"/>
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </DataTrigger.EnterActions>
                                        <DataTrigger.ExitActions>
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation
                                                        Storyboard.TargetProperty="Opacity"
                                                        To="0"
                                                        Duration="0:0:0.4"/>
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </DataTrigger.ExitActions>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                    </Border>
                    <!-- Chip content -->
                    <Border Background="{DynamicResource ControlFillColorDefaultBrush}"
                            BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                            BorderThickness="1"
                            CornerRadius="4"
                            Padding="8,2">
                        <TextBlock Text="{Binding Text}"
                                   VerticalAlignment="Center"
                                   FontSize="12"/>
                    </Border>
                </Grid>
            </StackPanel>
        </DataTemplate>
    </UserControl.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"
                              MinWidth="120"
                              SharedSizeGroup="HotkeyLabel"/>
            <ColumnDefinition Width="Auto"
                              MinWidth="120"
                              SharedSizeGroup="HotkeyChips"/>
            <ColumnDefinition Width="Auto"
                              SharedSizeGroup="HotkeyActions"/>
        </Grid.ColumnDefinitions>

        <!-- Action Name -->
        <TextBlock Grid.Column="0"
                   Text="{Binding HotkeyBinding.DisplayName, ElementName=HotkeyControl}"
                   VerticalAlignment="Center"
                   FontWeight="Medium"/>

        <!-- Hotkey Display -->
        <StackPanel Grid.Column="1"
                    Orientation="Horizontal"
                    VerticalAlignment="Center"
                    Margin="4,0"
                    MinHeight="24"
                    Visibility="{Binding IsNotEditing, ElementName=HotkeyControl, Converter={x:Static s:BoolToVisibilityConverter.Instance}}">
            <ItemsControl ItemsSource="{Binding HotkeyBinding.DisplayParts, ElementName=HotkeyControl}"
                          ItemTemplate="{StaticResource HotkeyChipTemplate}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
            </ItemsControl>
        </StackPanel>

        <!-- Edit mode overlay -->
        <Border Grid.Column="1"
                x:Name="EditBorder"
                Background="Transparent"
                BorderThickness="0"
                Padding="0"
                Margin="4,0"
                MinHeight="24"
                VerticalAlignment="Center"
                Visibility="{Binding IsEditing, ElementName=HotkeyControl, Converter={x:Static s:BoolToVisibilityConverter.Instance}}"
                Focusable="True"
                KeyDown="EditBorder_KeyDown"
                PreviewKeyDown="EditBorder_PreviewKeyDown">
            <ItemsControl ItemsSource="{Binding EditingParts, ElementName=HotkeyControl}"
                          ItemTemplate="{StaticResource HotkeyChipTemplate}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
            </ItemsControl>
        </Border>

        <!-- Action buttons row -->
        <StackPanel Grid.Column="2"
                    Orientation="Horizontal"
                    Margin="8,0,0,0"
                    VerticalAlignment="Center">
            <!-- Edit / Cancel -->
            <Button Click="EditButton_Click"
                    Style="{DynamicResource GhostIconButton}"
                    Padding="4"
                    ToolTip="Edit hotkey"
                    Visibility="{Binding IsNotEditing, ElementName=HotkeyControl, Converter={x:Static s:BoolToVisibilityConverter.Instance}}">
                <ui:SymbolIcon Symbol="Edit16"/>
            </Button>
            <Button Click="CancelEdit_Click"
                    Style="{DynamicResource GhostIconButton}"
                    Padding="4"
                    ToolTip="Cancel (Esc)"
                    Visibility="{Binding IsEditing, ElementName=HotkeyControl, Converter={x:Static s:BoolToVisibilityConverter.Instance}}">
                <ui:SymbolIcon Symbol="Dismiss16"/>
            </Button>

            <!-- Clear -->
            <Button Click="ClearButton_Click"
                    Style="{DynamicResource GhostIconButton}"
                    Padding="4"
                    ToolTip="Clear hotkey"
                    Visibility="{Binding IsNotEditing, ElementName=HotkeyControl, Converter={x:Static s:BoolToVisibilityConverter.Instance}}">
                <ui:SymbolIcon Symbol="Delete16"/>
            </Button>
        </StackPanel>
    </Grid>
</UserControl>
